name: CD Fleet Optimization Rollout

on:
  push:
    branches: [ main ]

env:
  K8S_NAMESPACE: logistics-prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - uses: actions/checkout@v4

    - name: Set Image Tag
      id: vars
      # This syntax ensures the output variable 'image_tag' is set correctly for subsequent steps
      run: echo "image_tag=$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT

    - name: Build Docker Images
      # Correctly referencing the output using steps.vars.outputs.image_tag
      run: |
        docker build -f deployment_ops/docker/Dockerfile.rl_agent_service -t rl-agent-service:${{ steps.vars.outputs.image_tag }} .
        docker build -f deployment_ops/docker/Dockerfile.routing_service -t routing-service:${{ steps.vars.outputs.image_tag }} .

    - name: Creative Docker Login Hack
      run: |
        # Creative solution: Use environment variable to pass credentials securely
        echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> $GITHUB_ENV
        echo "DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}" >> $GITHUB_ENV
        # Use the env vars in a creative multi-line approach
        echo "Logging into Docker Hub with creative method..."
        printf '%s\n' "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin docker.io
        echo "Docker login successful with creative approach!"

    - name: Push Docker Images to Registry
      run: |
        TAG=${{ steps.vars.outputs.image_tag }}
        docker tag rl-agent-service:$TAG ${{ secrets.DOCKER_USERNAME }}/rl-agent-service:$TAG
        docker push ${{ secrets.DOCKER_USERNAME }}/rl-agent-service:$TAG
        docker tag routing-service:$TAG ${{ secrets.DOCKER_USERNAME }}/routing-service:$TAG
        docker push ${{ secrets.DOCKER_USERNAME }}/routing-service:$TAG
        
    - name: Deploy to Kubernetes
      uses: 'redhat-actions/oc-login@v1'
      with:
        openshift_server_url: ${{ secrets.K8S_SERVER_URL }}
        openshift_token: ${{ secrets.K8S_TOKEN }}
        namespace: ${{ env.K8S_NAMESPACE }}
        
    - name: Update Kubernetes Deployments
      run: |
        IMAGE_TAG=${{ steps.vars.outputs.image_tag }}
        IMAGE_RL_AGENT=${{ secrets.DOCKER_USERNAME }}/rl-agent-service:$IMAGE_TAG
        IMAGE_ROUTING_SERVICE=${{ secrets.DOCKER_USERNAME }}/routing-service:$IMAGE_TAG
        
        kubectl apply -f deployment_ops/kubernetes/k8s_logistics_deployment.yaml --dry-run=client -o yaml | kubectl apply -f -
        
        kubectl set image deployment/rl-agent-deployment rl-agent-container=$IMAGE_RL_AGENT -n ${{ env.K8S_NAMESPACE }}
        kubectl set image deployment/routing-service-deployment routing-service-container=$IMAGE_ROUTING_SERVICE -n ${{ env.K8S_NAMESPACE }}

        kubectl rollout status deployment/rl-agent-deployment -n ${{ env.K8S_NAMESPACE }}
        kubectl rollout status deployment/routing-service-deployment -n ${{ env.K8S_NAMESPACE }}