name: CD Fleet Optimization Rollout

on:
  push:
    branches: [ main ]

env:
  K8S_NAMESPACE: logistics-prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - uses: actions/checkout@v4

    - name: Set Image Tag
      run: echo "IMAGE_TAG=${GITHUB_SHA::8}" >> $GITHUB_ENV

    - name: Build Docker Images
      run: |
        docker build -f deployment_ops/docker/Dockerfile.rl_agent_service -t rl-agent-service:${{ env.IMAGE_TAG }} .
        docker build -f deployment_ops/docker/Dockerfile.routing_service -t routing-service:${{ env.IMAGE_TAG }} .

    - name: Push Docker Images
      run: |
        TAG=${{ env.IMAGE_TAG }}
        USERNAME=${{ secrets.DOCKER_USERNAME }}
        PASSWORD=${{ secrets.DOCKER_PASSWORD }}
        REGISTRY=docker.io/$USERNAME

        echo "$PASSWORD" | docker login -u "$USERNAME" --password-stdin

        docker tag rl-agent-service:$TAG $REGISTRY/rl-agent-service:$TAG
        docker push $REGISTRY/rl-agent-service:$TAG

        docker tag routing-service:$TAG $REGISTRY/routing-service:$TAG
        docker push $REGISTRY/routing-service:$TAG

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3

    - name: Kubernetes Login
      run: |
        kubectl config set-cluster cluster --server=${{ secrets.K8S_SERVER_URL }} --insecure-skip-tls-verify=true
        kubectl config set-credentials github --token=${{ secrets.K8S_TOKEN }}
        kubectl config set-context default --cluster=cluster --user=github --namespace=${{ env.K8S_NAMESPACE }}
        kubectl config use-context default

    - name: Apply and Rollout
      run: |
        kubectl apply -f deployment_ops/kubernetes/k8s_logistics_deployment.yaml

        kubectl set image deployment/rl-agent-deployment rl-agent-container=${{ secrets.DOCKER_USERNAME }}/rl-agent-service:${{ env.IMAGE_TAG }} -n ${{ env.K8S_NAMESPACE }}
        kubectl rollout status deployment/rl-agent-deployment -n ${{ env.K8S_NAMESPACE }}

        kubectl set image deployment/routing-service-deployment routing-service-container=${{ secrets.DOCKER_USERNAME }}/routing-service:${{ env.IMAGE_TAG }} -n ${{ env.K8S_NAMESPACE }}
        kubectl rollout status deployment/routing-service-deployment -n ${{ env.K8S_NAMESPACE }}
