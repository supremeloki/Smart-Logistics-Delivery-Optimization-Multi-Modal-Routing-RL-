name: CD Fleet Optimization Rollout

on:
  push:
    branches: [ main ]

env:
  K8S_NAMESPACE: logistics-prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set Image Tag
      id: vars
      run: echo "image_tag=$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT

    - name: Build Docker Images
      run: |
        TAG=${{ steps.vars.outputs.image_tag }}
        docker build -f deployment_ops/docker/Dockerfile.rl_agent_service -t rl-agent-service:$TAG .
        docker build -f deployment_ops/docker/Dockerfile.routing_service -t routing-service:$TAG .

    - name: Authenticate to Docker Registry
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

    - name: Tag & Push Docker Images
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      run: |
        TAG=${{ steps.vars.outputs.image_tag }}
        docker tag rl-agent-service:$TAG $DOCKER_USERNAME/rl-agent-service:$TAG
        docker push $DOCKER_USERNAME/rl-agent-service:$TAG

        docker tag routing-service:$TAG $DOCKER_USERNAME/routing-service:$TAG
        docker push $DOCKER_USERNAME/routing-service:$TAG

        echo "âœ… Docker images pushed successfully!"

    - name: Login to Kubernetes Cluster
      uses: redhat-actions/oc-login@v1
      with:
        openshift_server_url: ${{ secrets.K8S_SERVER_URL }}
        openshift_token: ${{ secrets.K8S_TOKEN }}
        namespace: ${{ env.K8S_NAMESPACE }}

    - name: Deploy Updated Images to Kubernetes
      env:
        K8S_NAMESPACE: ${{ env.K8S_NAMESPACE }}
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      run: |
        TAG=${{ steps.vars.outputs.image_tag }}
        IMAGE_RL_AGENT=$DOCKER_USERNAME/rl-agent-service:$TAG
        IMAGE_ROUTING_SERVICE=$DOCKER_USERNAME/routing-service:$TAG

        echo "Applying Kubernetes manifests..."
        kubectl apply -f deployment_ops/kubernetes/k8s_logistics_deployment.yaml -n $K8S_NAMESPACE

        echo "Updating container images..."
        kubectl set image deployment/rl-agent-deployment rl-agent-container=$IMAGE_RL_AGENT -n $K8S_NAMESPACE
        kubectl set image deployment/routing-service-deployment routing-service-container=$IMAGE_ROUTING_SERVICE -n $K8S_NAMESPACE

        echo "Waiting for rollouts..."
        kubectl rollout status deployment/rl-agent-deployment -n $K8S_NAMESPACE
        kubectl rollout status deployment/routing-service-deployment -n $K8S_NAMESPACE

        echo "ðŸš€ Deployment successful!"
