name: CD Fleet Optimization Rollout

on:
  push:
    branches: [ main ]

env:
  K8S_NAMESPACE: logistics-prod
  IMAGE_PREFIX: fleetopt
  REGISTRY: docker.io

jobs:
  deploy:
    name: ğŸš€ Deploy Fleet Optimization Stack
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: ğŸ§© Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ§  Define Core Variables
      id: vars
      run: |
        IMAGE_TAG=$(echo "${GITHUB_SHA}" | cut -c1-8)
        echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
        echo "ğŸ§© Build Tag: $IMAGE_TAG"

    - name: ğŸ§± Verify Docker Environment (requirement-docker-core)
      run: |
        docker version || { echo "âŒ Docker not found!"; exit 1; }
        docker info | grep "Server" || { echo "âŒ Docker daemon not running!"; exit 1; }
        echo "âœ… Docker Core environment ready."

    - name: ğŸ› ï¸ Build Docker Images
      run: |
        TAG=${{ steps.vars.outputs.image_tag }}
        echo "ğŸ—ï¸ Building rl-agent-service:$TAG"
        docker build -f deployment_ops/docker/Dockerfile.rl_agent_service -t rl-agent-service:$TAG .
        echo "ğŸ—ï¸ Building routing-service:$TAG"
        docker build -f deployment_ops/docker/Dockerfile.routing_service -t routing-service:$TAG .
        echo "âœ… All images built successfully!"

    - name: ğŸ” Authenticate to Docker Hub
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
        echo "ğŸ”“ Docker authentication successful."

    - name: ğŸ“¦ Tag & Push Docker Images
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        REGISTRY: ${{ env.REGISTRY }}
      run: |
        TAG=${{ steps.vars.outputs.image_tag }}
        set -e  # stop on any failure

        for SERVICE in rl-agent-service routing-service; do
          echo "ğŸ”– Tagging $SERVICE:$TAG"
          docker tag $SERVICE:$TAG $REGISTRY/$DOCKER_USERNAME/$SERVICE:$TAG
          echo "ğŸ“¤ Pushing $REGISTRY/$DOCKER_USERNAME/$SERVICE:$TAG"
          docker push $REGISTRY/$DOCKER_USERNAME/$SERVICE:$TAG
        done

        echo "âœ… All Docker images pushed to registry!"

    - name: ğŸŒ Login to Kubernetes Cluster
      uses: redhat-actions/oc-login@v1
      with:
        openshift_server_url: ${{ secrets.K8S_SERVER_URL }}
        openshift_token: ${{ secrets.K8S_TOKEN }}
        namespace: ${{ env.K8S_NAMESPACE }}

    - name: âš™ï¸ Deploy to Kubernetes
      env:
        K8S_NAMESPACE: ${{ env.K8S_NAMESPACE }}
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        REGISTRY: ${{ env.REGISTRY }}
      run: |
        set -e
        TAG=${{ steps.vars.outputs.image_tag }}
        IMAGE_RL_AGENT=$REGISTRY/$DOCKER_USERNAME/rl-agent-service:$TAG
        IMAGE_ROUTING_SERVICE=$REGISTRY/$DOCKER_USERNAME/routing-service:$TAG

        echo "ğŸš€ Applying Kubernetes manifests..."
        kubectl apply -f deployment_ops/kubernetes/k8s_logistics_deployment.yaml -n $K8S_NAMESPACE

        echo "ğŸ”„ Updating deployments with new images..."
        kubectl set image deployment/rl-agent-deployment rl-agent-container=$IMAGE_RL_AGENT -n $K8S_NAMESPACE
        kubectl set image deployment/routing-service-deployment routing-service-container=$IMAGE_ROUTING_SERVICE -n $K8S_NAMESPACE

        echo "ğŸ•’ Waiting for rollouts to complete..."
        kubectl rollout status deployment/rl-agent-deployment -n $K8S_NAMESPACE --timeout=300s
        kubectl rollout status deployment/routing-service-deployment -n $K8S_NAMESPACE --timeout=300s

        echo "ğŸ¯ Rollout completed successfully!"

    - name: ğŸ§© Verify Deployment Health
      run: |
        kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o wide
        echo "âœ… All pods are healthy and running."

    - name: ğŸ‰ Deployment Summary
      run: |
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "âœ… CD Fleet Optimization Rollout Completed"
        echo "ğŸ”¹ Namespace: $K8S_NAMESPACE"
        echo "ğŸ”¹ Tag: ${{ steps.vars.outputs.image_tag }}"
        echo "ğŸ”¹ Timestamp: $(date)"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
